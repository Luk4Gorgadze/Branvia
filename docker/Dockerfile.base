# Base image with Node and pnpm
FROM node:18-alpine AS base

# Install pnpm globally and required packages
RUN npm install -g pnpm \
    && apk add --no-cache openssl bash python3 make g++

WORKDIR /app

# Copy database package for Prisma
COPY pnpm-workspace.yaml ./
COPY packages/database/ ./packages/database/
ARG DATABASE_URL
ENV DATABASE_URL=$DATABASE_URL

WORKDIR /app/packages/database
RUN pnpm install
RUN pnpm run generate
RUN pnpm run migrate:prod