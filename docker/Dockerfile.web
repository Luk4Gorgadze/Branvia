FROM base AS web-base
WORKDIR /app/web

COPY web/ ./

# DATABASE_URL is already available from base image, no need to redeclare
RUN echo "DATABASE_URL from base: $DATABASE_URL"

# Inject envs for Next.js runtime at build time
ARG REDIS_URL
ENV REDIS_URL=$REDIS_URL
ARG PAYPAL_CLIENT_ID
ENV PAYPAL_CLIENT_ID=$PAYPAL_CLIENT_ID
ARG PAYPAL_CLIENT_SECRET
ENV PAYPAL_CLIENT_SECRET=$PAYPAL_CLIENT_SECRET
ARG PAYPAL_MODE
ENV PAYPAL_MODE=$PAYPAL_MODE
ARG PAYPAL_BASE_URL
ENV PAYPAL_BASE_URL=$PAYPAL_BASE_URL

ARG TRUSTED_ORIGINS
ENV TRUSTED_ORIGINS=$TRUSTED_ORIGINS

# Also inject the public plan IDs if you have them
ARG NEXT_PUBLIC_APP_URL
ENV NEXT_PUBLIC_APP_URL=$NEXT_PUBLIC_APP_URL
ARG NEXT_PUBLIC_PAYPAL_STARTER_PLAN_ID
ENV NEXT_PUBLIC_PAYPAL_STARTER_PLAN_ID=$NEXT_PUBLIC_PAYPAL_STARTER_PLAN_ID
ARG NEXT_PUBLIC_PAYPAL_PROFESSIONAL_PLAN_ID
ENV NEXT_PUBLIC_PAYPAL_PROFESSIONAL_PLAN_ID=$NEXT_PUBLIC_PAYPAL_PROFESSIONAL_PLAN_ID
ARG NEXT_PUBLIC_PAYPAL_ENTERPRISE_PLAN_ID
ENV NEXT_PUBLIC_PAYPAL_ENTERPRISE_PLAN_ID=$NEXT_PUBLIC_PAYPAL_ENTERPRISE_PLAN_ID

RUN pnpm install

# Generate Prisma client with latest schema
RUN cd ../packages/database && pnpm prisma generate && cd ../../web

RUN pnpm run build

CMD cd ../packages/database && pnpm prisma migrate deploy && cd ../../web && pnpm start