# Use shared base image with built database package
FROM branvia-base AS base

# Build stage
FROM base AS builder
WORKDIR /app/web

# Copy the web directory contents
COPY web/ ./

# Copy .env file for build stage
COPY .env ./

# Install ALL dependencies (including dev dependencies for building)
RUN pnpm install

# Build the web app (with dotenv loading environment variables)
RUN pnpm dotenv -e .env pnpm run build

# Production stage
FROM base AS production
WORKDIR /app/web

# Copy the web directory contents
COPY web/ ./

# Install ONLY production dependencies
RUN pnpm install --prod

# Copy built application from builder stage
COPY --from=builder /app/web/.next ./.next
COPY --from=builder /app/web/public ./public
COPY --from=builder /app/web/package.json ./
COPY --from=builder /app/web/next.config.js ./
COPY --from=builder /app/web/jsconfig.json ./
