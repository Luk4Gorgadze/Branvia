FROM base AS migration

WORKDIR /app/packages/database

# Copy only the database package and its dependencies
COPY packages/database/ ./
COPY pnpm-workspace.yaml ./

# Install dependencies
RUN pnpm install

# Generate Prisma client
RUN pnpm prisma generate

# The migration service will wait for database to be ready, then run migrations
CMD ["sh", "-c", "echo 'ğŸ”„ Waiting for database to be ready...' && \
     until pnpm prisma db execute --stdin < /dev/null 2>/dev/null; do \
       echo 'â³ Database not ready, waiting...' && sleep 2; \
     done && \
     echo 'âœ… Database is ready, running migrations...' && \
     pnpm prisma migrate deploy && \
     echo 'âœ… Migrations completed successfully!'"]
